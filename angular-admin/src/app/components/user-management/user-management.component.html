<div class="users-container">
    <p-toast></p-toast>
    <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>
    
    <div class="card">
      <div class="flex justify-content-between align-items-center mb-3">
        <h2>User Management</h2>
        <p-button label="Add User" icon="pi pi-plus" (click)="openNew()"></p-button>
      </div>
      
      <div class="flex justify-content-end mb-3">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input 
            type="text" 
            pInputText 
            [(ngModel)]="searchQuery" 
            placeholder="Search users..." 
            (keyup.enter)="onSearch()"
          />
        </span>
        <p-button 
          label="Search" 
          styleClass="ml-2" 
          (click)="onSearch()"
        ></p-button>
      </div>
      
      <p-table 
        [value]="users" 
        [lazy]="true"
        [paginator]="true" 
        [rows]="rows"
        [totalRecords]="totalRecords"
        [loading]="loading"
        [rowsPerPageOptions]="[10, 25, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} users"
        [sortField]="sortField" 
        [sortOrder]="sortOrder"
        (onLazyLoad)="onLazyLoad($event)"
        styleClass="p-datatable-striped"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="firstName">Name <p-sortIcon field="firstName"></p-sortIcon></th>
            <th pSortableColumn="email">Email <p-sortIcon field="email"></p-sortIcon></th>
            <th pSortableColumn="role">Role <p-sortIcon field="role"></p-sortIcon></th>
            <th pSortableColumn="storageQuota">Storage Quota <p-sortIcon field="storageQuota"></p-sortIcon></th>
            <th pSortableColumn="aiQuota">AI Quota <p-sortIcon field="aiQuota"></p-sortIcon></th>
            <th pSortableColumn="createdAt">Created <p-sortIcon field="createdAt"></p-sortIcon></th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-user>
          <tr>
            <td>{{ user.firstName }} {{ user.lastName }}</td>
            <td>{{ user.email }}</td>
            <td>
              <p-tag 
                [value]="user.role === 'SYSTEM_ADMIN' ? 'Admin' : 'User'" 
                [severity]="getSeverity(user.role)"
              ></p-tag>
            </td>
            <td>{{ formatBytes(user.storageQuota) }}</td>
            <td>{{ user.aiQuota }} images</td>
            <td>{{ user.createdAt | date:'medium' }}</td>
            <td>
              <div class="flex gap-2">
                <p-button 
                  icon="pi pi-pencil" 
                  styleClass="p-button-sm p-button-text" 
                  (click)="editUser(user)"
                ></p-button>
                <p-button 
                  icon="pi pi-cog" 
                  styleClass="p-button-sm p-button-text p-button-success" 
                  (click)="openQuotasDialog(user)"
                  pTooltip="Manage Quotas"
                ></p-button>
                <p-button 
                  icon="pi pi-trash" 
                  styleClass="p-button-sm p-button-text p-button-danger" 
                  (click)="deleteUser(user)"
                ></p-button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center">No users found.</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="loadingbody">
          <tr>
            <td colspan="7" class="text-center">Loading users...</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
    
    <!-- User Dialog -->
    <p-dialog 
      [(visible)]="userDialog" 
      [style]="{width: '500px'}" 
      [header]="dialogMode === 'create' ? 'Add User' : 'Edit User'" 
      [modal]="true" 
      styleClass="p-fluid"
    >
      <div class="grid formgrid">
        <div class="field col-12 md:col-6">
          <label for="firstName">First Name*</label>
          <input 
            id="firstName" 
            type="text" 
            pInputText 
            [(ngModel)]="editingUser.firstName" 
            required 
            autocomplete="off"
          />
        </div>
        
        <div class="field col-12 md:col-6">
          <label for="lastName">Last Name*</label>
          <input 
            id="lastName" 
            type="text" 
            pInputText 
            [(ngModel)]="editingUser.lastName" 
            required 
            autocomplete="off"
          />
        </div>
        
        <div class="field col-12">
          <label for="email">Email*</label>
          <input 
            id="email" 
            type="email" 
            pInputText 
            [(ngModel)]="editingUser.email" 
            required 
            autocomplete="off"
          />
        </div>
        
        <div class="field col-12 md:col-6">
          <label for="role">Role*</label>
          <p-dropdown 
            id="role" 
            [options]="roleOptions" 
            [(ngModel)]="editingUser.role" 
            optionLabel="label" 
            optionValue="value"
            [required]="true"
            placeholder="Select a role"
          ></p-dropdown>
        </div>
        
        <div class="field col-12 md:col-6">
          <label for="storageQuota">Storage Quota (MB)*</label>
          <p-inputNumber 
            id="storageQuota" 
            [(ngModel)]="editingUser.storageQuota" 
            [min]="0" 
            [required]="true"
            [useGrouping]="false"
          ></p-inputNumber>
        </div>
        
        <div class="field col-12">
          <label for="aiQuota">AI Images Quota*</label>
          <p-inputNumber 
            id="aiQuota" 
            [(ngModel)]="editingUser.aiQuota" 
            [min]="0" 
            [required]="true"
            [useGrouping]="false"
          ></p-inputNumber>
        </div>
      </div>
      
      <ng-template pTemplate="footer">
        <p-button 
          label="Cancel" 
          icon="pi pi-times" 
          styleClass="p-button-text" 
          (click)="hideDialog()"
        ></p-button>
        <p-button 
          label="Save" 
          icon="pi pi-check" 
          (click)="saveUser()"
        ></p-button>
      </ng-template>
    </p-dialog>
    
    <!-- Quotas Dialog -->
    <p-dialog 
      [(visible)]="quotasDialog" 
      [style]="{width: '450px'}" 
      header="Update User Quotas" 
      [modal]="true" 
      styleClass="p-fluid"
    >
      <div *ngIf="selectedUser">
        <div class="user-info mb-4">
          <h3>{{ selectedUser.firstName }} {{ selectedUser.lastName }}</h3>
          <p>{{ selectedUser.email }}</p>
        </div>
        
        <div class="field">
          <label for="storageQuota">Storage Quota (MB)</label>
          <p-inputNumber 
            id="storageQuota" 
            [(ngModel)]="newStorageQuota" 
            [min]="0" 
            [required]="true"
            [useGrouping]="false"
          ></p-inputNumber>
          <small>Current: {{ formatBytes(selectedUser.storageQuota) }}</small>
        </div>
        
        <div class="field">
          <label for="aiQuota">AI Images Quota</label>
          <p-inputNumber 
            id="aiQuota" 
            [(ngModel)]="newAiQuota" 
            [min]="0" 
            [required]="true"
            [useGrouping]="false"
          ></p-inputNumber>
          <small>Current: {{ selectedUser.aiQuota }} images</small>
        </div>
      </div>
      
      <ng-template pTemplate="footer">
        <p-button 
          label="Cancel" 
          icon="pi pi-times" 
          styleClass="p-button-text" 
          (click)="hideQuotasDialog()"
        ></p-button>
        <p-button 
          label="Update" 
          icon="pi pi-check" 
          (click)="updateQuotas()"
        ></p-button>
      </ng-template>
    </p-dialog>
  </div>